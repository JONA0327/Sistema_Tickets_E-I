const N="[data-ticket-create]";document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(N);if(!e)return;const t=e.dataset.ticketType;P(e),(t==="software"||t==="hardware")&&F(e),t==="hardware"&&U(e),t==="software"&&A(e),j(e,t)});function P(e){const t=e.querySelector("#maintenanceScheduling");if(!t)return;const s=t.dataset.availabilityUrl,o=t.dataset.slotsUrl,n=e.querySelector("#calendarGrid"),r=e.querySelector("#calendarMonthLabel"),w=e.querySelector("#calendarPrev"),q=e.querySelector("#calendarNext"),m=e.querySelector("#selectedDateLabel"),u=e.querySelector("#selectedSlotLabel"),g=e.querySelector("#timeSlotsWrapper"),b=e.querySelector("#timeSlotsList"),i=e.querySelector("#noSlotsMessage"),x=e.querySelector("#maintenance_slot_id"),D=e.querySelector("#maintenance_selected_date");if(!n||!r||!w||!q||!m||!g||!b||!i||!x||!D)return;const _={available:"bg-green-100 text-green-700 border border-green-200 hover:bg-green-200",partial:"bg-yellow-100 text-yellow-700 border border-yellow-200 hover:bg-yellow-200",full:"bg-red-100 text-red-700 border border-red-200 cursor-not-allowed",empty:"bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed",past:"bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed"};let C={},L=D.value||null;const k=L?new Date(`${L}T00:00:00`):new Date;let c=new Date(k.getTime());w.addEventListener("click",()=>{c.setMonth(c.getMonth()-1),$()}),q.addEventListener("click",()=>{c.setMonth(c.getMonth()+1),$()}),$().then(()=>{L&&T(L,!0)});function $(){const p=`${c.getFullYear()}-${String(c.getMonth()+1).padStart(2,"0")}`;return fetch(`${s}?month=${p}`).then(f=>f.json()).then(f=>{C={},(f.days||[]).forEach(y=>{C[y.date]=y}),I()}).catch(()=>{n.innerHTML='<p class="col-span-7 text-sm text-red-600">No se pudo cargar la disponibilidad.</p>'})}function I(){n.innerHTML="";const p=new Date(c.getFullYear(),c.getMonth(),1),f=new Date(c.getFullYear(),c.getMonth()+1,0).getDate(),y=p.getDay();r.textContent=p.toLocaleDateString("es-MX",{month:"long",year:"numeric"}).replace(/^\w/u,d=>d.toUpperCase());for(let d=0;d<y;d+=1){const v=document.createElement("div");v.className="h-12",n.appendChild(v)}for(let d=1;d<=f;d+=1){const v=`${c.getFullYear()}-${String(c.getMonth()+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`,a=C[v],h=a?a.status:"empty",l=document.createElement("button");l.type="button",l.dataset.date=v,l.className=`h-12 rounded-xl flex flex-col items-center justify-center text-sm transition ${_[h]||_.empty}`,h==="full"||h==="empty"||h==="past"||a?.is_past?l.disabled=!0:(l.classList.add("cursor-pointer"),l.addEventListener("click",()=>T(v,!0))),L===v&&l.classList.add("ring-2","ring-blue-500","ring-offset-2"),l.innerHTML=`
                <span class="font-semibold">${d}</span>
                <span class="text-[11px]">${a?a.available:0}/${a?a.total_capacity:0}</span>
            `,n.appendChild(l)}}function T(p,f=!0){L=p,D.value=p,I(),f&&H(p)}function H(p){b.innerHTML="",i.classList.add("hidden"),i.textContent="No hay horarios disponibles para la fecha seleccionada.",g.classList.remove("hidden"),m.textContent=new Date(`${p}T00:00:00`).toLocaleDateString("es-MX",{day:"2-digit",month:"long",year:"numeric"}),u.textContent="",fetch(`${o}?date=${p}`).then(f=>f.json()).then(f=>{const y=f.slots||[];if(y.length===0){i.classList.remove("hidden"),x.value="";return}let d=!1;y.forEach(a=>{const h=a.status==="full"||a.status==="past"||a.available<=0,l=document.createElement("label");l.className="flex items-center justify-between gap-3 rounded-2xl border px-4 py-3 text-sm transition",h?l.classList.add("bg-gray-100","border-gray-200","cursor-not-allowed","opacity-70"):l.classList.add("cursor-pointer","border-blue-100","hover:border-blue-300","hover:bg-blue-50");const S=document.createElement("input");S.type="radio",S.name="maintenance_slot_choice",S.value=a.id,S.className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300",S.disabled=h,!h&&x.value&&String(x.value)===String(a.id)&&(S.checked=!0,u.textContent=`Horario seleccionado: ${a.label}`,d=!0),h||S.addEventListener("change",()=>{x.value=a.id,u.textContent=`Horario seleccionado: ${a.label}`});const E=document.createElement("div");E.className="flex flex-col text-left";let M=`${a.available} lugar(es) disponible(s)`;a.status==="past"?M="Horario no disponible (pasado)":a.status==="full"&&(M="Sin lugares disponibles"),E.innerHTML=`
                        <span class="font-semibold text-slate-800">${a.label}</span>
                        <span class="text-xs ${h?"text-gray-400":"text-slate-500"}">${M}</span>
                    `,l.appendChild(S),l.appendChild(E),b.appendChild(l)}),d||(x.value="",u.textContent=""),y.some(a=>a.status!=="past"&&a.status!=="full"&&a.available>0)||(i.classList.remove("hidden"),i.textContent="No hay horarios disponibles para la fecha seleccionada.")}).catch(()=>{i.classList.remove("hidden"),i.textContent="No se pudieron cargar los horarios disponibles."})}}function F(e){const t=e.querySelector("#imageInput"),s=e.querySelector("#uploadButton"),o=e.querySelector("#imagePreview"),n=e.querySelector("#imageCount");if(!t||!s||!o||!n)return;let r=new DataTransfer;const w=5;s.addEventListener("click",()=>{t.click()}),t.addEventListener("change",m=>{Array.from(m.target.files||[]).forEach(g=>{r.files.length<w&&g.type.startsWith("image/")&&r.items.add(g)}),q(),t.files=r.files});function q(){o.innerHTML="",n.textContent=`${r.files.length}/${w} imágenes`,Array.from(r.files).forEach((m,u)=>{const g=new FileReader;g.onload=b=>{const i=document.createElement("div");i.className="group relative overflow-hidden rounded-2xl border border-blue-100 bg-white shadow",i.innerHTML=`
                    <img src="${b.target?.result||""}" alt="Imagen ${u+1}" class="h-24 w-full object-cover" />
                    <button type="button" class="absolute -top-2 -right-2 flex h-6 w-6 items-center justify-center rounded-full bg-red-500 text-xs font-bold text-white opacity-0 transition hover:bg-red-600 group-hover:opacity-100" data-remove-index="${u}">×</button>
                    <div class="absolute inset-x-0 bottom-0 bg-black/50 px-2 py-1 text-[11px] text-white truncate">${m.name}</div>
                `,o.appendChild(i)},g.readAsDataURL(m)})}o.addEventListener("click",m=>{const u=m.target.closest("button[data-remove-index]");if(!u)return;m.preventDefault();const g=Number(u.dataset.removeIndex),b=Array.from(r.files);b.splice(g,1),r=new DataTransfer,b.forEach(i=>r.items.add(i)),t.files=r.files,q()})}function U(e){const t=e.querySelector("#tipo_equipo"),s=e.querySelector("#hardwareComputerInfo"),o=e.querySelector("#hardwarePrinterInfo");if(!t)return;const n=()=>{const r=t.value;s&&s.classList.toggle("hidden",r!=="Computadora"),o&&o.classList.toggle("hidden",r!=="Impresora")};t.addEventListener("change",n),n()}function A(e){const t=e.querySelector("#nombre_programa"),s=e.querySelector("#otroPrograma"),o=e.querySelector("#otro_programa_nombre");if(!t||!s||!o)return;const n=()=>{t.value==="Otro"?(s.classList.remove("hidden"),o.focus()):(s.classList.add("hidden"),o.value="")};t.addEventListener("change",n),n()}function j(e,t){const s=e.querySelector("form");s&&s.addEventListener("submit",o=>{if(t==="mantenimiento"){const n=e.querySelector("#maintenance_slot_id");if(!n||!n.value){alert("Por favor selecciona un horario de mantenimiento antes de crear el ticket."),o.preventDefault();return}}if(t==="hardware"){const n=e.querySelector("#tipo_equipo"),r=e.querySelector("#descripcion_problema");if(n&&!n.value){alert("Selecciona el tipo de equipo que presenta la falla."),n.focus(),o.preventDefault();return}r&&!r.value.trim()&&(alert("Describe la falla del equipo para poder atender tu solicitud."),r.focus(),o.preventDefault())}})}
